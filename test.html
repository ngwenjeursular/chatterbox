<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ChatterBox Chat Room</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

<div class="chat-room-container">
    <h2>Chat Room: {{ room_code }}</h2>
	<div>
		<p>Room Code: <input type="text" value="{{ room_code }}" id="roomCode" readonly>
		<button onclick="copyRoomCode()">Copy</button></p>
	</div>
    <p><strong>{{ creator }}</strong> created the room  <strong id="created-at" data-created-at="{{ created_at }}"></strong>.</p>

    <div class="chat-box" id="chat-box">
        <!-- Messages will appear here -->
    </div>

    <!-- Chat input box -->
    <div class="message-input-container">
        <form id="chat-form" onsubmit="sendMessage(); return false;">
			<div class="input-container">
				<textarea id="message-input" placeholder="Type a message..." required></textarea>
				<button type="submit" id="send-btn">Send</button>
			</div>
		</form>
		
    </div>
	<button id="leave-room-button">Leave Room</button>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>

<script>

	// Function to copy the room code to clipboard
	function copyRoomCode() {
		var roomCodeInput = document.getElementById("roomCode");
		roomCodeInput.select();
		roomCodeInput.setSelectionRange(0, 99999); // For mobile devices
		document.execCommand("copy");
		alert("Room code copied: " + roomCodeInput.value);
	}

	// Establish socket connection
	var socket = io('http://127.0.0.1:5000', {
		transports: ['websocket']
	});
	
	//const room = document.getElementById('roomCode').value;
	const room= "{{ room_code }}";
	const username = "{{ username }}";
	
	// Update profilePicture to use the full URL generated by Flask
	
	const profilePicture = "{{ profile_picture }}"


	socket.on('connect', function() {
        console.log('Connected to the server');
		socket.emit('join', { room: room, username: username, current_user: username });
        // You can join a room here if necessary
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from the server');
    });

	document.getElementById('message-input').addEventListener('input', function () {
		this.style.height = 'auto'; // Reset the height to auto to allow shrinking
		this.style.height = (this.scrollHeight) + 'px'; // Set height to scroll height
	});

	document.getElementById('message-input').addEventListener('keydown', function (event) {
		if (event.key === 'Enter' && !event.shiftKey) {
			event.preventDefault(); // Prevents adding a new line
			sendMessage(); // Calls sendMessage on Enter press
		}
	});
	// Function to send a message
	function sendMessage() {
		const messageInput = document.getElementById('message-input');
		const message = messageInput.value;
		if (message.trim() === "") return;

		console.log('Sending message:', message);
	
		// Check if message is not empty
		if (message.trim() !== '') {
			// Emit the send_message event to the server
			socket.emit('send_message', {
				message: message,
				room: room,
				username: username, // Use the initialized username
				profilePicture: profilePicture // Use the initialized profile picture
			});
	
			// Clear the input field
			messageInput.value = '';
			messageInput.style.height = '40px';
		}
	}
	
	function scrollToBottom() {
		const chatBox = document.querySelector('.chat-box');
		chatBox.scrollTop = chatBox.scrollHeight;
	}

	
	socket.on('receive_message', function(data) {
		const chatBox = document.getElementById('chat-box');
	
		const messageContainer = document.createElement('div');
		messageContainer.classList.add('message-container');

		// System message handling
		if (data.type === 'system') {
			const messageElement = document.createElement('div');
			messageElement.classList.add('system-message');
			
			// Display a personalized message for the current user
			const systemMessage = data.is_self ? 'You joined the room' : data.message;

			// Populate system message and timestamp
			messageElement.innerHTML = `<p>${systemMessage}</p><span>${data.time}</span>`;
			messageContainer.appendChild(messageElement);
		}  else {
			messageContainer.classList.add('message-container');
	
			// Apply 'outgoing' or 'incoming' based on username
			if (data.username === username) {
				messageContainer.classList.add('outgoing');
			} else {
				messageContainer.classList.add('incoming');
			}
	
			// Profile picture only for user messages
			if (data.profilePicture) {
				const profilePicElement = document.createElement('img');
				profilePicElement.src = data.profilePicture;
				profilePicElement.alt = 'Profile Picture';
				profilePicElement.classList.add('mini-profile-pic');
				messageContainer.appendChild(profilePicElement);
			}
	
			// Create content container for username, message, and timestamp
			const messageContent = document.createElement('div');
			messageContent.classList.add('message-content');
	
			// Add username for incoming messages
			if (data.username !== username) {
				const usernameElement = document.createElement('span');
				usernameElement.classList.add('username');
				usernameElement.innerText = data.username;
				messageContent.appendChild(usernameElement);
			}
	
			// Actual message text
			const messageText = document.createElement('div');
			messageText.classList.add('text');
			messageText.innerText = data.message;
			messageContent.appendChild(messageText);
	
			// Timestamp for the message
			if (data.time) {
				const timestampElement = document.createElement('div');
				timestampElement.classList.add('timestamp');
				timestampElement.innerText = data.time;
				messageContent.appendChild(timestampElement);
			}
	
			messageContainer.appendChild(messageContent);
		}
	
		// Append to chatBox and scroll to latest message
		chatBox.appendChild(messageContainer);
		chatBox.scrollTop = chatBox.scrollHeight;
	});
	
	function formatTimestamp(timestamp) {
		const now = new Date();
		const time = new Date(timestamp);
		const diffInMs = now - time;
		const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
		const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
		const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
	
		if (diffInMinutes < 1) {
			return "just now";
		} else if (diffInMinutes < 60) {
			return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;
		} else if (diffInHours < 24) {
			return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
		} else if (diffInDays < 7) {
			// Display the day name (e.g., "on Tuesday")
			const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
			return `on ${dayNames[time.getDay()]}`;
		} else {
			// For dates older than a week, show full date
			return time.toLocaleDateString(); // e.g., "10/21/2024"
		}
	}
	document.addEventListener("DOMContentLoaded", function () {
		const createdAtElement = document.getElementById("created-at");
		const rawTimestamp = createdAtElement.getAttribute("data-created-at");
	
		// Format the timestamp and set it as the text content
		createdAtElement.textContent = formatTimestamp(rawTimestamp);
	});
	
	document.getElementById('leave-room-button').addEventListener('click', function() {
		socket.emit('leave', { 'username': username, 'room': room });
	
		// Redirect the user to the room selection or main page
		window.location.href = '/home';
	});
	
	
</script>
</body>
</html>
